{% extends 'base.html' %}
{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <h1 style="margin-bottom:0;">My Proxies</h1>
    <div style="display:flex; gap:16px;">
        <form action="{{ url_for('main.dashboard') }}" method="get" style="display:flex;">
            <input type="text" name="q" placeholder="Filter by Asset UID..." value="{{ query }}" 
                   style="padding:10px; border-right:0; border-top-right-radius:0; border-bottom-right-radius:0;">
            <button type="submit" class="btn" style="border-top-left-radius:0; border-bottom-left-radius:0; margin-left:-1px;">Filter</button>
            {% if query %}
            <a href="{{ url_for('main.dashboard') }}" class="btn" style="background:#95a5a6; margin-left:8px;">Clear</a>
            {% endif %}
        </form>
        <a href="{{ url_for('main.create_proxy') }}" class="btn">Create New Config</a>
    </div>
</div>

<div class="card">
    {% if proxies %}
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Asset / Setting</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for proxy in proxies %}
            <tr>
                <td>
                    <div style="font-weight:500;">{{ proxy.name }}</div>
                </td>
                <td>
                    <div style="font-size:12px; color:var(--text-secondary);">Asset: {{ proxy.asset_uid }}</div>
                    <div style="font-size:12px; color:var(--text-secondary);">Setting: {{ proxy.setting_uid }}</div>
                </td>
                <td style="font-size:12px; color:var(--text-secondary);">
                    {{ proxy.created_at.strftime('%Y-%m-%d') if proxy.created_at else 'N/A' }}
                </td>
                <td>
                    <button class="btn btn-small copy-btn" 
                            data-url="{{ url_for('main.proxy_export', asset_uid=proxy.asset_uid, setting_uid=proxy.setting_uid, fmt='xlsx', _external=True, _scheme='https') }}?token={{ proxy.token }}">
                        Copy Link
                    </button>
                    <a href="{{ url_for('main.edit_proxy', id=proxy.id) }}" class="btn btn-small" style="background:#f4f5f7; color:var(--text-body); border:1px solid var(--border); margin-left:8px; text-decoration:none; display:inline-block;">
                        Edit
                    </a>
                    <a href="{{ url_for('main.delete_proxy', id=proxy.id) }}" 
                       style="color:#721c24; font-size:12px; margin-left:8px;"
                       onclick="return confirm('Are you sure? This will break any PBI dashboards using this token.')">
                       Delete
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <p>No proxy configurations found.</p>
        {% if query %}
        <p style="margin-top:8px;">Try a different filter or <a href="{{ url_for('main.dashboard') }}">clear search</a>.</p>
        {% else %}
        <p style="margin-top:8px;">Create one to get started.</p>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
    document.querySelectorAll('.copy-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const url = e.target.getAttribute('data-url');
            navigator.clipboard.writeText(url).then(() => {
                const originalText = e.target.innerText;
                e.target.innerText = 'Copied!';
                e.target.style.background = '#d4edda';
                e.target.style.color = '#155724';
                setTimeout(() => {
                    e.target.innerText = originalText;
                    e.target.style.background = 'var(--primary-blue)';
                    e.target.style.color = 'white';
                }, 2000);
            });
        });
    });
</script>
{% endblock %}
